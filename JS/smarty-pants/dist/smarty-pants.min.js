class PageInfo{constructor(e,t){this.uniqueID=e,this.visitID=t,this.loadTime=this.getPageLoadTime(),this.pathName=this.getPagePath(),this.referrer=this.getPageReferrer(),this.hitDate=Date.now(),this.activeTime=0}set newVisitID(e){this.visitID=e,this.hitDate=Date.now(),this.activeTime=0}set newActiveTime(e){this.activeTime=e}getPageReferrer(){return document.referrer}getPagePath(){return window.location.pathname}getPageLoadTime(){var e=window.performance.timing;return e.domContentLoadedEventEnd-e.navigationStart}}class Visit{constructor(e,t,i){this.uniqueID=e,this.visitID=t,this.cookieAgree=i,this.browser=this.defineBrowser(),this.screenWidth=this.getScreenWidth(),this.screenHeight=this.getScreenHeight(),this.createDate=Date.now()}set newVisitID(e){this.visitID=e,this.createDate=Date.now()}getScreenWidth(){return window.screen.width}getScreenHeight(){return window.screen.height}defineBrowser(){const e=navigator.userAgent;let t="Some browser";return 0<e.search(/Safari/)&&(t="Safari"),0<e.search(/Firefox/)&&(t="Firefox"),(0<e.search(/MSIE/)||0<e.search(/NET CLR /))&&(t="IE PC"),0<e.search(/Chrome/)&&(t="Google Chrome"),0<e.search(/YaBrowser/)&&(t="Yandex Browser"),0<e.search(/OPR/)&&(t="Opera PC"),0<e.search(/Konqueror/)&&(t="Konqueror"),0<e.search(/Iceweasel/)&&(t="Debian Iceweasel"),0<e.search(/SeaMonkey/)&&(t="SeaMonkey"),0<e.search(/Edge/)&&(t="MS Edge (Old)"),0<e.search(/Edg/)&&(t="MS Edge (Chrome Engine)"),0<e.search(/UCBrowser/i)&&(t="UC Browser"),0<e.search(/Opera Mini/i)&&(t="Opera Mini"),0<e.search(/iPhone|iPad|iPod/i)&&(t="Apple iOS"),0<e.search(/BlackBerry/i)&&(t="Blackberry Device"),0<e.search(/IEMobile/i)&&(t="IE Mobile"),0<e.search(/Android/i)&&(t="Android Device"),0<e.search(/Samsung/i)&&(t="Samsung Internet"),t}}function getCookie(e){e=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return e?decodeURIComponent(e[1]):void 0}function setCookie(e,t,i={}){(i={path:"/",...i}).expires instanceof Date&&(i.expires=i.expires.toUTCString());let n=encodeURIComponent(e)+"="+encodeURIComponent(t);for(var r in i){n+="; "+r;r=i[r];!0!==r&&(n+="="+r)}document.cookie=n}function deleteCookie(e){setCookie(e,"",{"max-age":-1})}const VISIT_TIME_MS=15e3,IDLE_TIMEOUT_SEC=10,ANALYTICS_HOST="http://localhost:5000",PAGE_INFO_URL=`${ANALYTICS_HOST}pages`,VISIT_INFO_URL=`${ANALYTICS_HOST}visits`;let startIdleMs=0,leaveTimer,pageInfo,visit;function grabKnowning(){TimeMe.initialize({idleTimeoutInSeconds:IDLE_TIMEOUT_SEC});let e=!1;void 0===getCookie("visitID")&&(e=!0);var t=getUniqueID(),i=getVisitID(),n=getCookieAgreement();visit=new Visit(t,i,n),console.log(`Visit class: ${JSON.stringify(visit)}`),e&&navigator.sendBeacon(`${ANALYTICS_HOST}/visits`,JSON.stringify(visit)),pageInfo=new PageInfo(t,i),console.log(`PageInfo class: ${JSON.stringify(pageInfo)}`),TimeMe.callWhenUserLeaves(()=>{startIdleMs=Date.now(),leaveTimer=setTimeout(()=>{pageInfo.newActiveTime=TimeMe.getTimeOnCurrentPageInMilliseconds(),navigator.sendBeacon(`${ANALYTICS_HOST}/pages`,JSON.stringify(pageInfo)),TimeMe.resetRecordedPageTime(TimeMe.currentPageName)},VISIT_TIME_MS)}),TimeMe.callWhenUserReturns(()=>{var e=Date.now()-startIdleMs;clearTimeout(leaveTimer),e>VISIT_TIME_MS&&(visit.newVisitID=generateVisitID(),setCookie("visitID",visit.visitID),navigator.sendBeacon(`${ANALYTICS_HOST}/visits`,JSON.stringify(visit)),TimeMe.startTimer(),pageInfo.newVisitID=visit.visitID,console.log(JSON.stringify(visit)),console.log(JSON.stringify(pageInfo))),startIdleMs=0})}function sendPageInfo(){pageInfo.newActiveTime=TimeMe.getTimeOnCurrentPageInMilliseconds(),navigator.sendBeacon(`${ANALYTICS_HOST}/pages`,JSON.stringify(pageInfo))}function getCookieAgreement(){return!0}function getUniqueID(){let e=getCookie("uniqueID");return e||(e=localStorage.getItem("uniqueID"),e||(e=generateUniqueID(),localStorage.setItem("uniqueID",e)),setCookie("uniqueID",e,{"Max-Age":2592e3}),e)}function generateUniqueID(){var e=Date.now();return`${Math.floor(9e4*Math.random())+1e4}${e}`}function getVisitID(){let e=getCookie("visitID");return console.log(document.cookie),console.log(`VisitID from cookies: ${e}`),void 0===e&&(e=generateVisitID(),setCookie("visitID",e)),e}function generateVisitID(){return`${Date.now()}${Math.floor(9e4*Math.random())+1e4}`}window.addEventListener("load",grabKnowning),window.addEventListener("beforeunload",sendPageInfo),(()=>{var e,t;e=this,t=()=>{let a={startStopTimes:{},idleTimeoutMs:3e4,currentIdleTimeMs:0,checkIdleStateRateMs:250,isUserCurrentlyOnPage:!0,isUserCurrentlyIdle:!1,currentPageName:"default-page-name",userLeftCallbacks:[],userReturnCallbacks:[],startTimer:(e,t)=>{if(e=e||a.currentPageName,void 0===a.startStopTimes[e])a.startStopTimes[e]=[];else{var i=a.startStopTimes[e],i=i[i.length-1];if(void 0!==i&&void 0===i.stopTime)return}a.startStopTimes[e].push({startTime:t||new Date,stopTime:void 0})},stopAllTimers:()=>{var t=Object.keys(a.startStopTimes);for(let e=0;e<t.length;e++)a.stopTimer(t[e])},stopTimer:(e,t)=>{e=e||a.currentPageName;let i=a.startStopTimes[e];void 0===i||0===i.length||void 0===i[i.length-1].stopTime&&(i[i.length-1].stopTime=t||new Date)},getTimeOnCurrentPageInSeconds:()=>a.getTimeOnPageInSeconds(a.currentPageName),getTimeOnPageInSeconds:e=>{e=a.getTimeOnPageInMilliseconds(e);return void 0===e?void 0:e/1e3},getTimeOnCurrentPageInMilliseconds:()=>a.getTimeOnPageInMilliseconds(a.currentPageName),getTimeOnPageInMilliseconds:e=>{var r=a.startStopTimes[e];if(void 0!==r){let n=0;for(let i=0;i<r.length;i++){let e=r[i].startTime,t=r[i].stopTime;void 0===t&&(t=new Date);var s=t-e;n+=s}return+n}},getFocusLostCountOnPage:e=>(e=e||a.currentPageName,a.startStopTimes[e].length),setIdleDurationInSeconds:e=>{var t=parseFloat(e);if(!1!==isNaN(t))throw{name:"InvalidDurationException",message:"An invalid duration time ("+e+") was provided."};a.idleTimeoutMs=1e3*e},setCurrentPageName:e=>{a.currentPageName=e},resetRecordedPageTime:e=>{delete a.startStopTimes[e]},resetAllRecordedPageTimes:()=>{var t=Object.keys(a.startStopTimes);for(let e=0;e<t.length;e++)a.resetRecordedPageTime(t[e])},userActivityDetected:()=>{a.isUserCurrentlyIdle&&a.triggerUserHasReturned(),a.resetIdleCountdown()},resetIdleCountdown:()=>{a.isUserCurrentlyIdle=!1,a.currentIdleTimeMs=0},callWhenUserLeaves:(e,t)=>{a.userLeftCallbacks.push({callback:e,numberOfTimesToInvoke:t})},callWhenUserReturns:(e,t)=>{a.userReturnCallbacks.push({callback:e,numberOfTimesToInvoke:t})},triggerUserHasReturned:()=>{if(!a.isUserCurrentlyOnPage){a.isUserCurrentlyOnPage=!0,a.resetIdleCountdown();for(let i=0;i<a.userReturnCallbacks.length;i++){let e=a.userReturnCallbacks[i],t=e.numberOfTimesToInvoke;(isNaN(t)||void 0===t||0<t)&&(--e.numberOfTimesToInvoke,e.callback())}}a.startTimer()},triggerUserHasLeftPageOrGoneIdle:()=>{if(a.isUserCurrentlyOnPage){a.isUserCurrentlyOnPage=!1;for(let i=0;i<a.userLeftCallbacks.length;i++){let e=a.userLeftCallbacks[i],t=e.numberOfTimesToInvoke;(isNaN(t)||void 0===t||0<t)&&(--e.numberOfTimesToInvoke,e.callback())}}a.stopAllTimers()},checkIdleState:()=>{!1===a.isUserCurrentlyIdle&&a.currentIdleTimeMs>a.idleTimeoutMs?(a.isUserCurrentlyIdle=!0,a.triggerUserHasLeftPageOrGoneIdle()):a.currentIdleTimeMs+=a.checkIdleStateRateMs},visibilityChangeEventName:void 0,hiddenPropName:void 0,listenForVisibilityEvents:(e,t)=>{e&&a.listenForUserLeavesOrReturnsEvents(),t&&a.listForIdleEvents()},listenForUserLeavesOrReturnsEvents:()=>{void 0===document.hidden?void 0===document.mozHidden?void 0===document.msHidden?void 0!==document.webkitHidden&&(a.hiddenPropName="webkitHidden",a.visibilityChangeEventName="webkitvisibilitychange"):(a.hiddenPropName="msHidden",a.visibilityChangeEventName="msvisibilitychange"):(a.hiddenPropName="mozHidden",a.visibilityChangeEventName="mozvisibilitychange"):(a.hiddenPropName="hidden",a.visibilityChangeEventName="visibilitychange"),document.addEventListener(a.visibilityChangeEventName,()=>{document[a.hiddenPropName]?a.triggerUserHasLeftPageOrGoneIdle():a.triggerUserHasReturned()},!1),window.addEventListener("blur",()=>{a.triggerUserHasLeftPageOrGoneIdle()}),window.addEventListener("focus",()=>{a.triggerUserHasReturned()})},listForIdleEvents:()=>{document.addEventListener("mousemove",()=>{a.userActivityDetected()}),document.addEventListener("keyup",()=>{a.userActivityDetected()}),document.addEventListener("touchstart",()=>{a.userActivityDetected()}),window.addEventListener("scroll",()=>{a.userActivityDetected()}),setInterval(()=>{!0!==a.isUserCurrentlyIdle&&a.checkIdleState()},a.checkIdleStateRateMs)},initialize:e=>{let t,i=a.idleTimeoutMs||30,n=a.currentPageName||"default-page-name",r=!0,s=!0;e&&(i=e.idleTimeoutInSeconds||i,n=e.currentPageName||n,t=e.initialStartTime,!1===e.trackWhenUserLeavesPage&&(r=!1),!1===e.trackWhenUserGoesIdle&&(s=!1)),a.setIdleDurationInSeconds(i),a.setCurrentPageName(n),a.listenForVisibilityEvents(r,s),a.startTimer(void 0,t)}};return a},"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define([],()=>e.TimeMe=t()):e.TimeMe=t()}).call(this);